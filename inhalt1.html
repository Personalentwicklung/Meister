<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIKP - Personalentwicklung</title>
    <style>
        /* Allgemeine Einstellungen für den Body (direkt aus ZIP-13.html übernommen) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 40px 20px; /* Einheitlicher Padding wie in ZIP-13 */
            background-color: #f0f2f5; /* Hintergrundfarbe wie in ZIP-13 */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Startpunkt des Containers anpassen */
            min-height: 100vh;
            box-sizing: border-box; /* Wichtig für konsistentes Box-Modell */
        }

        /* Container für den gesamten Test, um ihn zu zentrieren und zu stylen (direkt aus ZIP-13.html übernommen) */
        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Schatten wie in ZIP-13 */
            max-width: 900px; /* Max-Breite für bessere Lesbarkeit */
            width: 100%; /* Breite anpassen */
            margin-top: 20px; /* Abstand nach oben */
        }

        /* Titel des Tests (direkt aus ZIP-13.html übernommen) */
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        /* Styling für einzelne Fragen-Sektionen */
        .question-section {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .question-section h2 {
            color: #34495e;
            margin-top: 0;
            font-size: 1.6em;
            margin-bottom: 15px;
        }

        .question-section p {
            line-height: 1.8;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
        }

        /* Textarea für die Antwort */
        textarea {
            width: calc(100% - 20px);
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1.05em;
            min-height: 150px;
            resize: vertical; /* Ermöglicht vertikales Resizing */
            box-sizing: border-box; /* Padding und Border sind Teil der Gesamtbreite */
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap; /* Verhindert Zeilenumbruch bei langen Texten */
        }

        .btn-check-answer {
            background-color: #28a745; /* Grün für "Antwort überprüfen" */
            color: white;
            border: none;
        }

        .btn-check-answer:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .recheck-button {
            background-color: #ffc107; /* Orange für "Antwort erneut prüfen" */
            color: #333;
            border: none;
        }

        .recheck-button:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }

        .btn-solution {
            background-color: #007bff; /* Blau für "Musterlösung anzeigen" */
            color: white;
            border: none;
            margin-left: 15px; /* Abstand zum Check-Button */
        }

        .btn-solution:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        /* Feedback Sektion */
        .feedback-section {
            background-color: #e9f7ef; /* Helles Grün */
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            display: none; /* Standardmäßig versteckt */
        }

        .feedback-section h3 {
            color: #28a745; /* Dunkelgrün */
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .feedback-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .feedback-section ul li {
            margin-bottom: 10px;
            font-size: 1.05em;
            display: flex;
            align-items: flex-start;
        }

        .feedback-section ul li .icon {
            margin-right: 10px;
            font-size: 1.2em;
            min-width: 20px; /* Für konsistente Ausrichtung */
        }

        .feedback-section ul li .text {
            flex-grow: 1;
        }

        .total-score {
            font-weight: bold;
            margin-top: 15px;
            font-size: 1.2em;
            color: #34495e;
            text-align: right;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        /* Musterlösung Sektion */
        .solution-section {
            background-color: #f0f8ff; /* Helles Blau */
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none; /* Standardmäßig versteckt */
        }

        .solution-section h3 {
            color: #007bff; /* Dunkelblau */
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .solution-section .correct-answer-content p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .solution-section .correct-answer-content strong {
            font-weight: bold;
            color: #333;
        }

        /* Symbole für Feedback */
        .icon.positive { color: #28a745; } /* Grün */
        .icon.neutral { color: #ffc107; }  /* Orange */
        .icon.negative { color: #dc3545; } /* Rot */

        .recheck-info-text {
            color: #6c757d;
            font-size: 0.95em;
            margin-top: 10px;
            display: none; /* Standardmäßig versteckt */
        }

        /* Responsive Design (falls benötigt, hier nur Basis) */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            body {
                padding: 20px 10px;
            }
            .btn {
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="question-container">
        <h1>Der Personalentwicklungsprozess</h1>
        </div>

    <template id="question-template">
        <div class="question-section" data-question-id="">
            <h2 class="question-title"></h2>
            <p class="question-text"></p>
            <textarea class="user-answer" placeholder="Ihre Antwort hier eingeben..."></textarea>
            <div style="display: flex; align-items: center; flex-wrap: wrap;">
                <button class="btn btn-check-answer">Antwort überprüfen</button>
                <button class="btn btn-solution" style="display: none;">Musterlösung anzeigen</button>
            </div>
            <p class="recheck-info-text">Um eine Antwort erneut zu prüfen, können Sie Änderungen vornehmen und den Button erneut klicken.</p>

            <div class="feedback-section" style="display: none;">
                <h3>Ihr Feedback:</h3>
                <ul class="feedback-list">
                    </ul>
                <p class="total-score"></p>
            </div>

            <div class="solution-section" style="display: none;">
                <h3>Musterlösung:</h3>
                <div class="correct-answer-content">
                    </div>
            </div>
        </div>
    </template>

    <script>
        let questions = []; // Hier werden die geladenen Fragen gespeichert
        const defaultThemaId = 'pe-prozess'; // Die Standard-Themen-ID für diese Seite

        async function loadQuestions() {
            try {
                const response = await fetch('fragen_pe-prozess.json');
                if (!response.ok) {
                    throw new Error(`HTTP-Fehler! Status: ${response.status}`);
                }
                const data = await response.json();
                questions = data.filter(q => q.themaID === defaultThemaId).sort((a, b) => a.frageNummer - b.frageNummer);
                displayQuestions();
            } catch (error) {
                console.error("Fehler beim Laden der Fragen:", error);
                document.getElementById('question-container').innerHTML = '<p style="color: red; text-align: center;">Fehler beim Laden der Fragen. Bitte versuchen Sie es später erneut.</p>';
            }
        }

        function displayQuestions() {
            const container = document.getElementById('question-container');
            const template = document.getElementById('question-template');

            // Überschrift nicht erneut hinzufügen, wenn sie schon da ist
            if (container.querySelector('h1') === null) {
                 const h1 = document.createElement('h1');
                 h1.textContent = 'Der Personalentwicklungsprozess';
                 container.appendChild(h1);
            } else {
                 // Vorhandene Fragen entfernen, falls bereits geladen
                 container.querySelectorAll('.question-section').forEach(section => section.remove());
            }

            questions.forEach((question, index) => {
                const clone = document.importNode(template.content, true);
                const questionSection = clone.querySelector('.question-section');
                questionSection.dataset.questionId = question.id; // Speichern der ID im Dataset

                clone.querySelector('.question-title').textContent = question.titel;
                clone.querySelector('.question-text').textContent = question.frageText;

                const answerInput = clone.querySelector('.user-answer');
                answerInput.id = 'answer-input-' + question.id; // Eindeutige ID vergeben
                answerInput.value = question.userAnswer || ''; // Laden der vorherigen Antwort, falls vorhanden

                const checkButton = clone.querySelector('.btn-check-answer');
                checkButton.id = 'check-answer-button-' + question.id; // Eindeutige ID
                checkButton.addEventListener('click', () => evaluateAnswer(index));

                const toggleSolutionButton = clone.querySelector('.btn-solution');
                toggleSolutionButton.id = 'toggle-solution-button-' + question.id; // Eindeutige ID
                const solutionContainer = clone.querySelector('.solution-section');
                solutionContainer.id = 'solution-section-' + question.id; // Eindeutige ID
                toggleSolutionButton.addEventListener('click', () => toggleMusterloesung(question, toggleSolutionButton, solutionContainer));

                const feedbackSection = clone.querySelector('.feedback-section');
                feedbackSection.id = 'feedback-section-' + question.id; // Eindeutige ID
                const feedbackList = clone.querySelector('.feedback-list');
                feedbackList.id = 'feedback-list-' + question.id; // Eindeutige ID
                const totalScoreElement = clone.querySelector('.total-score');
                totalScoreElement.id = 'total-score-' + question.id; // Eindeutige ID

                const recheckInfoText = clone.querySelector('.recheck-info-text');
                recheckInfoText.id = 'recheck-info-text-' + question.id; // Eindeutige ID

                container.appendChild(clone);
            });
        }

        // VERBESSERTER SIMPLE STEMMER (TEIL A)
        function simpleStemmer(word) {
            // Umwandlung in Kleinbuchstaben und Entfernen aller nicht-alphanumerischen Zeichen
            // Behält Umlaute bei (äöüß)
            word = word.toLowerCase().replace(/[^a-zäöüß]/g, ''); 

            // Ein etwas verbesserter, aber immer noch einfacher Stemmer für Deutsch
            // Längere Endungen zuerst prüfen
            if (word.length > 3) { // Nur bei längeren Wörtern stemmen, um Kernwörter nicht zu verstümmeln
                if (word.endsWith('schaften')) {
                    word = word.slice(0, -7);
                } else if (word.endsWith('ungen')) {
                    word = word.slice(0, -5);
                } else if (word.endsWith('ieren')) {
                    word = word.slice(0, -5);
                } else if (word.endsWith('ismus')) {
                    word = word.slice(0, -5);
                } else if (word.endsWith('erung')) {
                    word = word.slice(0, -5);
                } else if (word.endsWith('en')) {
                    word = word.slice(0, -2);
                } else if (word.endsWith('ern')) {
                    word = word.slice(0, -3);
                } else if (word.endsWith('es')) {
                    word = word.slice(0, -2);
                } else if (word.endsWith('e')) {
                    word = word.slice(0, -1);
                } else if (word.endsWith('n')) {
                    word = word.slice(0, -1);
                } else if (word.endsWith('s')) {
                    word = word.slice(0, -1);
                } else if (word.endsWith('st')) {
                    word = word.slice(0, -2);
                } else if (word.endsWith('est')) {
                    word = word.slice(0, -3);
                }
            }
            return word;
        }

        async function evaluateAnswer(questionIndex) {
            const currentQuestion = questions[questionIndex];
            const answerInput = document.getElementById('answer-input-' + currentQuestion.id);
            const userAnswer = answerInput.value;
            // Speichere die aktuelle Antwort temporär im Fragenobjekt (nur im Browser-Speicher)
            currentQuestion.userAnswer = userAnswer; 

            const feedbackSection = document.getElementById('feedback-section-' + currentQuestion.id);
            const feedbackList = document.getElementById('feedback-list-' + currentQuestion.id);
            const totalScoreElement = document.getElementById('total-score-' + currentQuestion.id);
            const toggleSolutionButton = document.getElementById('toggle-solution-button-' + currentQuestion.id);
            const recheckInfoText = document.getElementById('recheck-info-text-' + currentQuestion.id);
            const checkButton = document.getElementById('check-answer-button-' + currentQuestion.id);
            const solutionTextElement = document.getElementById('solution-text-' + currentQuestion.id); // Nicht verwendet, kann entfernt werden wenn nicht gebraucht

            feedbackList.innerHTML = ''; // Vorheriges Feedback leeren

            const userWords = userAnswer.split(/\s+/).filter(word => word.length > 0);
            let totalPoints = 0;
            let maxPoints = 0;

            for (const kriterium of currentQuestion.bewertungskriterien) {
                let hasKeyword = false;
                let points = 0;
                let feedbackText = '';
                maxPoints += 2; // Jedes Kriterium kann max. 2 Punkte geben

                const stemmedKeywords = kriterium.keywords.map(kw => simpleStemmer(kw));

                for (const userWord of userWords) {
                    const stemmedUserWord = simpleStemmer(userWord);
                    for (const stemmedKeyword of stemmedKeywords) {
                        // PRÜFUNG AUF EXAKTEN MATCH DES GESTEMMTEN WORTES (TEIL B)
                        if (stemmedUserWord === stemmedKeyword) {
                            hasKeyword = true;
                            break; // Keyword gefunden, Schleife für dieses Kriterium beenden
                        }
                    }
                    if (hasKeyword) break; // Keyword gefunden, Schleife für dieses Kriterium beenden
                }

                const meetsMinWords = userWords.length >= kriterium.minWoerterFuerBeschreibung;

                // Punktevergabe und Feedback-Generierung
                let iconClass = '';
                if (hasKeyword && meetsMinWords) {
                    points = 2;
                    feedbackText = kriterium.feedback_kurz.positiv || 'Sehr gut! Der Punkt wurde genannt und ausreichend beschrieben.';
                    iconClass = 'positive';
                } else if (hasKeyword && !meetsMinWords) {
                    points = 1;
                    feedbackText = kriterium.feedback_kurz.neutral || 'Der Punkt wurde genannt, aber die Beschreibung ist noch nicht ausreichend.';
                    iconClass = 'neutral';
                } else {
                    points = 0;
                    feedbackText = kriterium.feedback_kurz.negativ || 'Der Punkt wurde nicht gefunden. Ihre Antwort sollte diesen Punkt behandeln.';
                    iconClass = 'negative';
                }

                totalPoints += points;

                const listItem = document.createElement('li');
                listItem.innerHTML = `<span class="icon ${iconClass}">
                                        ${iconClass === 'positive' ? '✅' : iconClass === 'neutral' ? '⚠️' : '❌'}
                                      </span>
                                      <span class="text">${feedbackText}</span>`;
                feedbackList.appendChild(listItem);
            }

            totalScoreElement.textContent = `Gesamtpunktzahl: ${totalPoints} von ${maxPoints}`;
            feedbackSection.style.display = 'block';
            toggleSolutionButton.style.display = 'block'; // Musterlösungs-Button anzeigen

            // "Antwort überprüfen" Button anpassen
            checkButton.textContent = 'Antwort erneut prüfen';
            checkButton.classList.add('recheck-button');

            // Dynamischen Text anzeigen
            recheckInfoText.style.display = 'block';
        }

        function toggleMusterloesung(question, button, solutionContainer) {
            if (solutionContainer.style.display === 'block') {
                solutionContainer.style.display = 'none';
                button.textContent = 'Musterlösung anzeigen';
            } else {
                // Ersetze **Text** durch <strong>Text</strong>
                let formattedSolution = question.musterloesung.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // Teile den Text an doppelten Zeilenumbrüchen in Absätze auf
                const paragraphs = formattedSolution.split(/\n\s*\n/).filter(p => p.trim() !== '');
                let htmlContent = '';
                paragraphs.forEach(p => {
                    // Ersetze einzelne Zeilenumbrüche innerhalb eines Absatzes durch <br>
                    htmlContent += `<p>${p.replace(/\n/g, '<br>')}</p>`;
                });

                solutionContainer.querySelector('.correct-answer-content').innerHTML = htmlContent;
                solutionContainer.style.display = 'block';
                button.textContent = 'Musterlösung ausblenden';
            }
        }

        // Start der Anwendung
        document.addEventListener('DOMContentLoaded', loadQuestions);
    </script>
</body>
</html>
