<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIKP - Personalentwicklung</title>
  <style>
    /* Grundlegende HTML/Body Stile basierend auf ZIP-13.html Analyse */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif; /* Häufig verwendete Schriftart, die Standard ist */
      background-color: #f0f0f0; /* Heller grauer Hintergrund */
      color: #333;
      display: flex; /* Für zentrale Ausrichtung des Containers */
      justify-content: center; /* Horizontale Zentrierung */
      align-items: flex-start; /* Oben beginnen, nicht in der Mitte */
      padding: 20px; /* Äußerer Abstand zum Rand */
      box-sizing: border-box; /* Padding wird in Breite/Höhe inkludiert */
    }

    /* Hauptcontainer */
    .container {
      background-color: #ffffff;
      padding: 25px 30px; /* Angepasstes Padding */
      border: 1px solid #ccc; /* Feinerer Rand */
      border-radius: 5px; /* Leichte Abrundung */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Subtiler Schatten */
      max-width: 780px; /* Angepasste maximale Breite näher an ZIP-13 */
      width: 100%;
      box-sizing: border-box;
    }

    /* Überschriftenstile */
    h1 {
      color: #0066cc; /* Dunkleres Blau, typisch für Überschriften im Original */
      text-align: center;
      font-size: 2em; /* Angepasste Größe */
      margin-top: 0;
      margin-bottom: 5px;
      font-weight: bold;
    }
    h2 {
      color: #0066cc; /* Konsistent mit H1 */
      text-align: center;
      font-size: 1.4em; /* Angepasste Größe */
      font-weight: normal;
      margin-top: 0;
      margin-bottom: 25px; /* Abstand zum Inhalt */
    }
    h3 {
      color: #0066cc;
      font-size: 1.1em;
      margin-top: 0;
      margin-bottom: 10px;
      font-weight: bold; /* H3 sind typischerweise fett */
    }

    /* Fragen-Navigationsleiste */
    .question-navigation-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 7px; /* Feinere Abstände */
      margin-bottom: 20px;
      justify-content: center;
    }
    .question-navigation-bar button {
      padding: 7px 14px; /* Angepasstes Padding für einheitliche Höhe */
      font-size: 0.95em; /* Etwas kleiner */
      cursor: pointer;
      background-color: #e0e0e0; /* Hellgrau */
      color: #444;
      border: 1px solid #c0c0c0; /* Hellerer Rand */
      border-radius: 4px;
      transition: background-color 0.15s ease, border-color 0.15s ease;
      line-height: 1.2; /* Für konsistente Höhen */
      min-height: 32px; /* Einheitliche Mindesthöhe für Buttons */
      box-sizing: border-box;
    }
    .question-navigation-bar button.active {
      background-color: #007bff; /* Aktiver Button-Hintergrund */
      color: white;
      border-color: #007bff;
    }
    .question-navigation-bar button:hover:not(.active) {
      background-color: #d0d0d0;
      border-color: #b0b0b0;
    }
    .question-navigation-bar button.active:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }

    /* Textarea für Benutzerantwort */
    textarea {
      width: 100%;
      height: 160px; /* Angepasste Höhe */
      font-size: 1em;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #cccccc;
      border-left: 5px solid #007bff; /* Blauer Rand links */
      border-radius: 4px;
      font-family: inherit;
      box-sizing: border-box;
      resize: vertical; /* Nur vertikale Größenänderung */
    }

    /* "Antwort überprüfen" Button */
    .btn-check-answer {
      display: block;
      padding: 12px 20px;
      background-color: #28a745; /* Grün */
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1.1em;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 25px;
      width: 100%;
      box-sizing: border-box;
      font-weight: bold; /* Meist fett im Original */
    }
    .btn-check-answer:hover {
      background-color: #218838;
    }
    .btn-check-answer.recheck-button {
        background-color: #ffc107; /* Gelb */
        color: #333; /* Dunkle Schrift */
    }
    .btn-check-answer.recheck-button:hover {
        background-color: #e0a800; /* Dunkleres Gelb */
    }

    /* Fragen-Sektion */
    .question-section {
      padding: 20px;
      border: 1px solid #ddd; /* Leichterer Rand */
      margin-bottom: 25px;
      border-radius: 5px;
      background-color: #fdfdfd; /* Fast weiß */
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04); /* Sehr subtiler Schatten */
    }

    /* Feedback- und Musterlösung-Bereiche */
    .feedback-section,
    .correct-answer-content-container {
      margin-top: 20px;
      padding: 15px;
      background-color: #e6f2ff; /* Hellblau, wie im Original */
      border-left: 5px solid #007bff; /* Blauer Balken links */
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04); /* Einheitlicher Schatten */
    }
    .feedback-section h4,
    .correct-answer-content-container h4 {
        color: #0066cc; /* Überschriftenfarbe */
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.1em;
        font-weight: bold;
    }
    /* Kriterien-Feedback */
    .criteria-feedback {
      margin-top: 10px;
    }
    .feedback-item {
      margin-bottom: 5px;
      padding: 6px 0;
      border-bottom: 1px dashed #e0e0e0;
      display: flex;
      align-items: flex-start; /* Icons und Text oben bündig */
      line-height: 1.4; /* Für bessere Lesbarkeit */
    }
    .feedback-item:last-child {
      border-bottom: none;
    }
    .feedback-item .icon {
        font-size: 1.1em;
        margin-right: 8px;
        flex-shrink: 0; /* Verhindert Schrumpfen des Icons */
        padding-top: 2px; /* Leichte Anpassung für vertikale Ausrichtung */
    }
    .feedback-item strong {
        font-weight: bold;
    }
    .feedback-item.positive { color: #28a745; } /* Grün */
    .feedback-item.neutral { color: #ffc107; } /* Gelb */
    .feedback-item.negative { color: #dc3545; } /* Rot */

    /* Punktestand-Anzeige */
    .score-display {
      margin-top: 15px;
      font-weight: bold;
      font-size: 1em;
      color: #0066cc;
      border-top: 1px solid #dcdcdc; /* Trennlinie */
      padding-top: 10px;
    }

    /* Musterlösung-Anzeige Button */
    .btn-toggle-musterloesung {
        background-color: #007bff; /* Blau */
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.3s ease;
        width: 100%;
        display: block;
        box-sizing: border-box;
        font-weight: bold;
    }
    .btn-toggle-musterloesung:hover {
        background-color: #0056b3;
    }

    /* Responsive Anpassungen */
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }
        .container {
            padding: 15px;
        }
        h1 {
            font-size: 1.8em;
        }
        h2 {
            font-size: 1.2em;
        }
        .question-navigation-bar {
            flex-direction: column;
            align-items: stretch; /* Buttons füllen die Breite */
        }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>MIKP - Personalentwicklung</h1>
    <h2 id="thema-sub-titel"></h2>

    <div class="thema-selector">
      <div id="thema-buttons">
        </div>
    </div>

    <div id="thema-pe-prozess" class="thema-block">
        <div id="questions-container">
            </div>
    </div>

  </div>

  <template id="questionTemplate">
    <div class="question-section" data-question-id="">
      <h3 class="question-title"></h3>
      <p class="question-text"></p>
      <div>
        <label for="" class="form-label">Ihre Antwort:</label>
        <textarea class="user-answer" rows="8"></textarea>
      </div>
      <button class="btn-check-answer">Antwort überprüfen</button>
      
      <div class="feedback-section" style="display:none;">
        <h4>Feedback:</h4>
        <div class="criteria-feedback"></div>
        <div class="score-display">Gesamterreichung: <span class="score-percentage"></span>%</div>
      </div>

      <div class="correct-answer-toggle" style="margin-top: 20px;">
        <button class="btn-info btn-toggle-musterloesung" style="display:none;">Musterlösung anzeigen</button>
        <div class="correct-answer-content-container" style="display:none;">
            <div class="correct-answer-content"></div>
        </div>
      </div>
    </div>
  </template>

  <script src="./index.js"></script>

  <script>
    let alleGeladeneFragen = {}; // Speichert alle Fragen nach ThemaID
    let aktuellesThema = ''; // Speichert das aktuell ausgewählte Thema
    let aktuelleFrageIndex = 0; // Speichert den Index der aktuell angezeigten Frage im Thema

    // Definition der Themen und ihrer Fragen (Angepasst, um Fragen-IDs dynamisch zu füllen)
    const themen = {
      'pe-prozess': {
        h2Text: 'Personalentwicklungsprozess',
        fragen: [] // Wird nach dem Laden der JSON-Fragen dynamisch mit Fragen-IDs gefüllt
      }
      // Weitere Themen können hier hinzugefügt werden, falls Ihre JSON weitere themaIDs enthält
    };
    let stemWordFunc; // Variable für die Stemming-Funktion

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialisiere den Stemmer
      if (typeof snowballFactory !== 'undefined') {
        const germanStemmer = snowballFactory.newStemmer('German');
        stemWordFunc = (word) => germanStemmer.stem(word);
      } else {
        console.error('Snowball Stemmer (index.js) wurde nicht korrekt geladen oder snowballFactory ist nicht verfügbar. Stemming wird deaktiviert.');
        stemWordFunc = (word) => word; // Fallback: gebe das Wort unverändert zurück
      }

      await ladeFragen(); // Lade alle Fragen aus der JSON-Datei
      erstelleThemaNavigation(); // Erstelle die Navigationsbuttons für Themen (jetzt leer)
      initialisiereApp(); // Initialisiere die Anwendung basierend auf URL-Hash oder Standard
    });

    function erstelleThemaNavigation() {
      // Punkt 1: Diese Funktion wurde geändert, um keine Buttons mehr zu erstellen.
      // Der thema-buttons Container bleibt leer, da keine Navigation über Buttons gewünscht ist.
      const themaButtonsContainer = document.getElementById('thema-buttons');
      themaButtonsContainer.innerHTML = ''; 
      // Der Titel (h2Text) wird direkt in initialisiereApp() gesetzt
    }

    async function ladeFragen() {
      try {
        const response = await fetch('./fragen_pe-prozess.json');
        if (!response.ok) {
          throw new Error(`HTTP-Fehler! Status: ${response.status}`);
        }
        const data = await response.json();
        // Gruppiere Fragen nach ihrer themaID und fülle das themen-Objekt
        data.forEach(frage => {
          if (!alleGeladeneFragen[frage.themaID]) {
            alleGeladeneFragen[frage.themaID] = [];
          }
          alleGeladeneFragen[frage.themaID].push(frage);
          
          // Stelle sicher, dass themen[frage.themaID].fragen die IDs der Fragen enthält,
          // aber nur wenn das Thema bereits im 'themen'-Objekt existiert.
          if (themen[frage.themaID] && !themen[frage.themaID].fragen.includes(frage.id)) {
            themen[frage.themaID].fragen.push(frage.id);
          }
        });
        // Fragen innerhalb jedes Themas nach frageNummer sortieren
        for (const themaID in alleGeladeneFragen) {
          alleGeladeneFragen[themaID].sort((a, b) => a.frageNummer - b.frageNummer);
          // Aktualisiere die Reihenfolge der Fragen-IDs im themen-Objekt basierend auf Sortierung
          if (themen[themaID]) { // Prüfen, ob Thema existiert, bevor es aktualisiert wird
            themen[themaID].fragen = alleGeladeneFragene[themaID].map(f => f.id);
          }
        }

      } catch (error) {
        console.error("Fehler beim Laden der Fragen-JSON-Datei:", error);
      }
    }

    // Zeigt ein spezifisches Thema an und erstellt dessen Fragen-UI
    function zeigeThema(themaID) {
      document.getElementById('thema-sub-titel').textContent = themen[themaID].h2Text;
      aktuellesThema = themaID;

      erstelleFragenUI(themaID); // Fragen-UI für das Thema erstellen

      // Zeige die erste Frage des Themas, falls vorhanden
      if (alleGeladeneFragen[themaID] && alleGeladeneFragen[themaID].length > 0) {
        zeigeFrage(themaID, 0); // Zeige die erste Frage (Index 0)
      } else {
        document.getElementById('questions-container').innerHTML = '<p>Keine Fragen für dieses Thema gefunden.</p>';
      }
    }

    // Erstellt die UI für alle Fragen eines Themas mit dem Template
    function erstelleFragenUI(themaID) {
        const questionsContainer = document.getElementById('questions-container');
        const questionTemplate = document.getElementById('questionTemplate');
        questionsContainer.innerHTML = ''; // Inhalt leeren, um neue Fragen zu laden

        const fragenDesThemas = alleGeladeneFragen[themaID];
        if (!fragenDesThemas) return;

        // Fragen-Navigation (oben im questions-container)
        const questionNavBar = document.createElement('div');
        questionNavBar.classList.add('question-navigation-bar');
        fragenDesThemas.forEach((frage, index) => {
            const navButton = document.createElement('button');
            navButton.id = `nav-${frage.id}`;
            navButton.textContent = `Frage ${frage.frageNummer}`;
            navButton.onclick = () => zeigeFrage(themaID, index);
            questionNavBar.appendChild(navButton);
        });
        questionsContainer.appendChild(questionNavBar);

        // Füge die Fragen mit dem Template hinzu
        fragenDesThemas.forEach((frage, index) => {
            const clone = document.importNode(questionTemplate.content, true);
            const questionSection = clone.querySelector('.question-section');
            questionSection.id = frage.id; // Eindeutige ID für die Frage-Sektion
            questionSection.setAttribute('data-question-id', frage.id); // data-Attribut ebenfalls setzen

            clone.querySelector('.question-title').textContent = frage.titel;
            clone.querySelector('.question-text').textContent = frage.frageText;
            
            const userAnswerTextarea = clone.querySelector('.user-answer');
            userAnswerTextarea.id = `user-answer-${frage.id}`; // Eindeutige ID für die Textarea
            clone.querySelector('label').setAttribute('for', userAnswerTextarea.id);

            const checkAnswerButton = clone.querySelector('.btn-check-answer');
            const toggleMusterloesungBtn = clone.querySelector('.btn-toggle-musterloesung');
            const correctAnswerContentContainer = clone.querySelector('.correct-answer-content-container');

            checkAnswerButton.addEventListener('click', () => {
                evaluateAnswer(frage.id, questionSection, frage);
                // Button-Text und -Farbe nach Überprüfung ändern
                checkAnswerButton.textContent = 'Antwort erneut prüfen';
                checkAnswerButton.classList.add('recheck-button');
                // Musterlösungs-Button einblenden
                toggleMusterloesungBtn.style.display = 'block';
            });

            // Musterlösung: Sternchen durch <strong> ersetzen
            let formattedMusterloesung = frage.musterloesung.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedMusterloesung = formattedMusterloesung.replace(/\n/g, '<br>'); // Zeilenumbrüche beibehalten
            clone.querySelector('.correct-answer-content').innerHTML = formattedMusterloesung;
            
            toggleMusterloesungBtn.addEventListener('click', (event) => {
                if (correctAnswerContentContainer.style.display === 'none') {
                    correctAnswerContentContainer.style.display = 'block';
                    event.target.textContent = 'Musterlösung ausblenden';
                } else {
                    correctAnswerContentContainer.style.display = 'none';
                    event.target.textContent = 'Musterlösung anzeigen';
                }
            });
            // Feedback-Bereich anpassen
            const feedbackSection = clone.querySelector('.feedback-section');
            feedbackSection.id = `feedback-${frage.id}`;

            questionsContainer.appendChild(clone);
        });
    }

    // Zeigt eine spezifische Frage innerhalb eines Themas an
    function zeigeFrage(themaID, frageIndex) {
      const fragenArray = alleGeladeneFragen[themaID];
      if (!fragenArray || fragenArray.length <= frageIndex) {
        console.error(`Frage mit Index ${frageIndex} für Thema ${themaID} nicht gefunden.`);
        return;
      }
      const frageID = fragenArray[frageIndex].id; // Die eindeutige ID der Frage

      // Alle Fragen im aktuellen Thema ausblenden
      document.querySelectorAll(`#questions-container .question-section`).forEach(section => {
        section.style.display = 'none';
      });
      // Die gewünschte Frage anzeigen
      document.getElementById(frageID).style.display = 'block';

      // Aktiven Navigations-Button hervorheben
      document.querySelectorAll(`#questions-container .question-navigation-bar button`).forEach(btn => {
        btn.classList.remove('active');
      });
      // Sicherstellen, dass der Button existiert, bevor .classList.add() aufgerufen wird
      const navButtonToActivate = document.getElementById(`nav-${frageID}`);
      if (navButtonToActivate) {
        navButtonToActivate.classList.add('active');
      }

      aktuelleFrageIndex = frageIndex; // Aktualisiere den globalen Index
    }

    // Bewertungslogik
    function evaluateAnswer(frageId, sectionElement, frageData) {
        const userAnswer = sectionElement.querySelector(`#user-answer-${frageId}`).value;
        const feedbackSection = sectionElement.querySelector(`#feedback-${frageId}`);
        const criteriaFeedbackDiv = feedbackSection.querySelector('.criteria-feedback');
        const scorePercentageSpan = feedbackSection.querySelector('.score-percentage');
        criteriaFeedbackDiv.innerHTML = ''; // Alten Feedback löschen
        feedbackSection.style.display = 'block';

        let totalPossibleScore = 0;
        let userAchievedScore = 0;

        const userWords = cleanAndStemText(userAnswer, stemWordFunc);

        frageData.bewertungskriterien.forEach(criterion => {
            const feedbackItem = document.createElement('div');
            feedbackItem.classList.add('feedback-item');
            let criterionScore = 0;
            let keywordFound = false;

            totalPossibleScore += 2; // Each criterion is worth 2 points if fully recognized and described

            // Check for keywords
            for (const keyword of criterion.keywords) {
                const stemmedKeyword = stemWordFunc(keyword.toLowerCase());
                if (userWords.includes(stemmedKeyword)) {
                    keywordFound = true;
                    break;
                }
            }

            if (keywordFound) {
                const cleanUserAnswer = userAnswer.toLowerCase().replace(/[.,!?;:()"]/g, '');
                const wordsInUserAnswer = cleanUserAnswer.split(/\s+/).filter(word => word.length > 0);
                let sufficientlyDescribed = false;

                if (wordsInUserAnswer.length >= criterion.minWoerterFuerBeschreibung) {
                    sufficientlyDescribed = true;
                }
                
                if (sufficientlyDescribed) {
                    criterionScore = 2; // Full points
                    feedbackItem.classList.add('positive');
                    feedbackItem.innerHTML = `<span class="icon">✔️</span> <strong>${criterion.name}:</strong> Sehr gut! Der Punkt wurde genannt und ausreichend beschrieben.`;
                } else {
                    criterionScore = 1; // Partial points
                    feedbackItem.classList.add('neutral');
                    feedbackItem.innerHTML = `<span class="icon">⚠️</span> <strong>${criterion.name}:</strong> ${criterion.feedback_kurz || 'Der Punkt wurde genannt, aber die Beschreibung ist noch nicht ausreichend.'}`;
                }
            } else {
                criterionScore = 0; // No points
                feedbackItem.classList.add('negative');
                feedbackItem.innerHTML = `<span class="icon">❌</span> <strong>${criterion.name}:</strong> Nicht gefunden. Ihre Antwort sollte diesen Punkt behandeln.`;
            }
            userAchievedScore += criterionScore;
            criteriaFeedbackDiv.appendChild(feedbackItem);
        });

        const overallPercentage = totalPossibleScore > 0 ? ((userAchievedScore / totalPossibleScore) * 100).toFixed(0) : 0;
        scorePercentageSpan.textContent = overallPercentage;
    }

    // Hilfsfunktion zum Bereinigen und Stemmen des Textes
    function cleanAndStemText(text, stemmer) {
        const cleanedText = text.toLowerCase().replace(/[.,!?;:()"]/g, '');
        return cleanedText.split(/\s+/).filter(word => word.length > 0).map(word => stemmer(word));
    }

    // Initialisierung beim Laden der Seite
    async function initialisiereApp() {
      const hash = window.location.hash.substring(1);
      const startThemaID = hash || 'pe-prozess'; // Standardthema 'pe-prozess' oder aus URL-Hash
      zeigeThema(startThemaID); // Zeige das Startthema
    }
  </script>

</body>
</html>
