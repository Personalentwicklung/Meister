<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIKP - Personalentwicklung</title>
  <style>
    /* Allgemeine Einstellungen für den Body */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 40px 20px;
      background-color: #f0f2f5;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    /* Container für den gesamten Test, um ihn zu zentrieren und zu stylen */
    .container {
      background-color: #ffffff;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      max-width: 900px;
      width: 100%;
      box-sizing: border-box;
    }
    h1 {
      color: #1a4e8a;
      text-align: center;
      font-size: 2.2em;
      margin-bottom: 5px; /* Abstand zum Sub-Titel */
    }
    h2 {
      color: #1a4e8a;
      text-align: center;
      font-size: 1.5em;
      font-weight: normal; /* Nicht-bold-Anforderung */
      margin-top: 0;
      margin-bottom: 30px;
    }
    h3 {
      margin-top: 0;
      color: #1a4e8a;
    }
    .question-navigation-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .question-navigation-bar button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #666;
      color: white;
      border: 1px solid #444;
      border-radius: 5px;
      transition: background-color 0.1s ease;
    }
    .question-navigation-bar button.active {
      background-color: #1a4e8a;
      color: white;
      border-color: #1a4e8a;
    }
    .question-navigation-bar button:active {
      transform: scale(0.98);
    }
    textarea {
      width: 100%;
      height: 200px;
      font-size: 16px;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #cddff5;
      border-left: 5px solid #1a4e8a; /* Blauer Balken links */
      border-radius: 5px;
      font-family: inherit; /* Die Schriftart wird vom body-Element geerbt */
    }
    button.check-button {
      display: block;
      padding: 15px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1.2em;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 30px;
      width: 100%;
    }
    button.check-button:hover {
      background-color: #218838;
    }
    button.check-button:active {
      transform: scale(0.98);
    }
    button.recheck-button {
      background-color: #d4ac0d;
    }
    button.recheck-button:hover {
      background-color: #b38e0b;
    }
    button.solution-button {
      display: block;
      padding: 15px 20px;
      background-color: #1a4e8a;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1.2em;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 30px;
      width: 100%;
    }
    button.solution-button:hover {
      background-color: #1a3e7a;
    }
    button.solution-button:active {
      transform: scale(0.98);
    }
    .question-section {
      padding: 25px;
      border: 1px solid #cddff5;
      margin-bottom: 30px;
      border-radius: 8px;
      background-color: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .feedback-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #e6eff9;
      border-left: 5px solid #1a4e8a; /* Blauer Balken links */
      transition: background-color 0.5s ease;
    }
    .feedback-section.highlight {
        background-color: #d8e5f8;
    }
    .solution-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #e6eff9;
      border-left: 5px solid #1a4e8a;
    }
    .ok { color: green; }
    .hinweis { color: #d17b00; }
    .error { color: red; }

    /* New styles for feedback criteria */
    .criteria-feedback {
      margin-top: 10px;
    }
    .feedback-item {
      margin-bottom: 5px;
      padding: 8px 0;
      border-bottom: 1px dashed #c0c0c0;
    }
    .feedback-item:last-child {
      border-bottom: none;
    }
    .feedback-item.positive {
      color: #28a745; /* Green */
    }
    .feedback-item.neutral {
      color: #d17b00; /* Orange/Yellow */
    }
    .feedback-item.negative {
      color: #dc3545; /* Red */
    }
    .score-display {
      margin-top: 15px;
      font-weight: bold;
      font-size: 1.1em;
      color: #1a4e8a;
    }
    .correct-answer-toggle {
        margin-top: 20px;
    }
    .btn-toggle-musterloesung {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.3s ease;
        width: 100%;
        display: block;
        box-sizing: border-box;
    }
    .btn-toggle-musterloesung:hover {
        background-color: #0056b3;
    }
    .btn-check-answer { /* Style for the check answer button from the template */
      display: block;
      padding: 15px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1.2em;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 20px; /* Adjusted margin-top for consistency */
      width: 100%;
      box-sizing: border-box;
    }
    .btn-check-answer:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>MIKP - Personalentwicklung</h1>
    <h2 id="thema-sub-titel"></h2>

    <div class="thema-selector">
      <div id="thema-buttons">
        </div>
    </div>

    <div id="thema-pe-prozess" class="thema-block">
        <div id="questions-container">
            </div>
    </div>

  </div>

  <template id="questionTemplate">
    <div class="question-section" data-question-id="">
      <h3 class="question-title"></h3>
      <p class="question-text"></p>
      <div>
        <label for="" class="form-label">Ihre Antwort:</label>
        <textarea class="user-answer" rows="8"></textarea>
      </div>
      <button class="btn-check-answer">Antwort überprüfen</button>
      
      <div class="feedback-section" style="display:none;">
        <h4>Bewertung:</h4>
        <div class="criteria-feedback"></div>
        <div class="score-display">Gesamterreichung: <span class="score-percentage"></span>%</div>
      </div>

      <div class="correct-answer-toggle" style="margin-top: 20px;">
        <button class="btn-info btn-toggle-musterloesung">Musterlösung anzeigen</button>
        <div class="correct-answer-content" style="display:none;"></div>
      </div>
    </div>
  </template>

  <script src="./index.js"></script>

  <script>
    let alleGeladeneFragen = {}; // Speichert alle Fragen nach ThemaID 
    let aktuellesThema = ''; // Speichert das aktuell ausgewählte Thema 
    let aktuelleFrageIndex = 0; // Speichert den Index der aktuell angezeigten Frage im Thema 

    // Definition der Themen und ihrer Fragen (Angepasst, um Fragen-IDs dynamisch zu füllen) 
    const themen = {
      'pe-prozess': {
        h2Text: 'Personalentwicklungsprozess',
        fragen: [] // Wird nach dem Laden der JSON-Fragen dynamisch mit Fragen-IDs gefüllt 
      }
      // Weitere Themen können hier hinzugefügt werden, falls Ihre JSON weitere themaIDs enthält 
    };
    let stemWordFunc; // Variable für die Stemming-Funktion 

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialisiere den Stemmer 
      if (typeof snowballFactory !== 'undefined') {
        const germanStemmer = snowballFactory.newStemmer('German');
        stemWordFunc = (word) => germanStemmer.stem(word);
      } else {
        console.error('Snowball Stemmer (index.js) wurde nicht korrekt geladen oder snowballFactory ist nicht verfügbar. Stemming wird deaktiviert.'); [cite: 2]
        stemWordFunc = (word) => word; // Fallback: gebe das Wort unverändert zurück 
      }

      await ladeFragen(); // Lade alle Fragen aus der JSON-Datei 
      erstelleThemaNavigation(); // Erstelle die Navigationsbuttons für Themen 
      initialisiereApp(); // Initialisiere die Anwendung basierend auf URL-Hash oder Standard 
    });

    function erstelleThemaNavigation() {
      const themaButtonsContainer = document.getElementById('thema-buttons');
      themaButtonsContainer.innerHTML = ''; // Vorherige Buttons entfernen 
      for (const themaID in themen) {
        const button = document.createElement('button');
        button.textContent = themen[themaID].h2Text;
        button.onclick = () => zeigeThema(themaID);
        themaButtonsContainer.appendChild(button);
      }
    }

    async function ladeFragen() {
      try {
        const response = await fetch('./fragen_pe-prozess.json'); [cite: 2]
        if (!response.ok) {
          throw new Error(`HTTP-Fehler! Status: ${response.status}`); [cite: 2]
        }
        const data = await response.json(); [cite: 2]
        // Gruppiere Fragen nach ihrer themaID und fülle das themen-Objekt 
        data.forEach(frage => {
          if (!alleGeladeneFragen[frage.themaID]) {
            alleGeladeneFragen[frage.themaID] = [];
          }
          alleGeladeneFragen[frage.themaID].push(frage);
          
          // Stelle sicher, dass themen[themaID].fragen die IDs der Fragen enthält,
          // aber nur wenn das Thema bereits im 'themen'-Objekt existiert. 
          if (themen[frage.themaID] && !themen[frage.themaID].fragen.includes(frage.id)) {
            themen[frage.themaID].fragen.push(frage.id);
          }
        });
        // Fragen innerhalb jedes Themas nach frageNummer sortieren 
        for (const themaID in alleGeladeneFragen) {
          alleGeladeneFragen[themaID].sort((a, b) => a.frageNummer - b.frageNummer);
          // Aktualisiere die Reihenfolge der Fragen-IDs im themen-Objekt basierend auf Sortierung 
          if (themen[themaID]) { // Prüfen, ob Thema existiert, bevor es aktualisiert wird 
            themen[themaID].fragen = alleGeladeneFragen[themaID].map(f => f.id);
          }
        }

      } catch (error) {
        console.error("Fehler beim Laden der Fragen-JSON-Datei:", error); [cite: 2]
      }
    }

    // Zeigt ein spezifisches Thema an und erstellt dessen Fragen-UI 
    function zeigeThema(themaID) {
      // Aktuellen Themen-Button hervorheben
      document.querySelectorAll('#thema-buttons button').forEach(btn => {
        btn.classList.remove('active');
      });
      const currentThemaButton = document.querySelector(`#thema-buttons button[onclick="zeigeThema('${themaID}')"]`);
      if (currentThemaButton) {
        currentThemaButton.classList.add('active');
      }

      document.getElementById('thema-sub-titel').textContent = themen[themaID].h2Text;
      aktuellesThema = themaID;

      erstelleFragenUI(themaID); // Fragen-UI für das Thema erstellen 

      // Zeige die erste Frage des Themas, falls vorhanden
      if (alleGeladeneFragen[themaID] && alleGeladeneFragen[themaID].length > 0) {
        zeigeFrage(themaID, 0); // Zeige die erste Frage (Index 0) 
      } else {
        document.getElementById('questions-container').innerHTML = '<p>Keine Fragen für dieses Thema gefunden.</p>'; [cite: 2]
      }
    }

    // Erstellt die UI für alle Fragen eines Themas mit dem Template 
    function erstelleFragenUI(themaID) {
        const questionsContainer = document.getElementById('questions-container'); [cite: 2]
        const questionTemplate = document.getElementById('questionTemplate'); [cite: 2]
        questionsContainer.innerHTML = ''; // Inhalt leeren, um neue Fragen zu laden 

        const fragenDesThemas = alleGeladeneFragen[themaID]; [cite: 2]
        if (!fragenDesThemas) return; [cite: 2]

        // Fragen-Navigation (oben im questions-container)
        const questionNavBar = document.createElement('div');
        questionNavBar.classList.add('question-navigation-bar');
        fragenDesThemas.forEach((frage, index) => {
            const navButton = document.createElement('button');
            navButton.id = `nav-${frage.id}`;
            navButton.textContent = `Frage ${frage.frageNummer}`;
            navButton.onclick = () => zeigeFrage(themaID, index);
            questionNavBar.appendChild(navButton);
        });
        questionsContainer.appendChild(questionNavBar); [cite: 2]

        // Füge die Fragen mit dem Template hinzu
        fragenDesThemas.forEach((frage, index) => {
            const clone = document.importNode(questionTemplate.content, true);
            const questionSection = clone.querySelector('.question-section');
            questionSection.id = frage.id; // Eindeutige ID für die Frage-Sektion 
            questionSection.setAttribute('data-question-id', frage.id); // data-Attribut ebenfalls setzen 

            clone.querySelector('.question-title').textContent = frage.titel; [cite: 2]
            clone.querySelector('.question-text').textContent = frage.frageText;
            
            const userAnswerTextarea = clone.querySelector('.user-answer');
            userAnswerTextarea.id = `user-answer-${frage.id}`; // Eindeutige ID für die Textarea 
            clone.querySelector('label').setAttribute('for', userAnswerTextarea.id);

            clone.querySelector('.btn-check-answer').addEventListener('click', () => {
                evaluateAnswer(frage.id, questionSection, frage); [cite: 2]
            });

            const correctAnswerContentDiv = clone.querySelector('.correct-answer-content');
            correctAnswerContentDiv.innerHTML = frage.musterloesung.replace(/\n/g, '<br>'); [cite: 2]
            const toggleMusterloesungBtn = clone.querySelector('.btn-toggle-musterloesung');
            toggleMusterloesungBtn.addEventListener('click', (event) => {
                if (correctAnswerContentDiv.style.display === 'none') {
                    correctAnswerContentDiv.style.display = 'block';
                    event.target.textContent = 'Musterlösung ausblenden';
                } else {
                    correctAnswerContentDiv.style.display = 'none';
                    event.target.textContent = 'Musterlösung anzeigen';
                }
            });
            // Feedback-Bereich anpassen
            const feedbackSection = clone.querySelector('.feedback-section'); [cite: 2]
            feedbackSection.id = `feedback-${frage.id}`; [cite: 2]

            questionsContainer.appendChild(clone);
        });
    }

    // Zeigt eine spezifische Frage innerhalb eines Themas an 
    function zeigeFrage(themaID, frageIndex) {
      const fragenArray = alleGeladeneFragen[themaID]; [cite: 2]
      if (!fragenArray || fragenArray.length <= frageIndex) {
        console.error(`Frage mit Index ${frageIndex} für Thema ${themaID} nicht gefunden.`); [cite: 2]
        return;
      }
      const frageID = fragenArray[frageIndex].id; // Die eindeutige ID der Frage 

      // Alle Fragen im aktuellen Thema ausblenden
      document.querySelectorAll(`#questions-container .question-section`).forEach(section => {
        section.style.display = 'none';
      });
      // Die gewünschte Frage anzeigen
      document.getElementById(frageID).style.display = 'block'; [cite: 2]

      // Aktiven Navigations-Button hervorheben
      document.querySelectorAll(`#questions-container .question-navigation-bar button`).forEach(btn => {
        btn.classList.remove('active');
      });
      // Sicherstellen, dass der Button existiert, bevor .classList.add() aufgerufen wird 
      const navButtonToActivate = document.getElementById(`nav-${frageID}`);
      if (navButtonToActivate) {
        navButtonToActivate.classList.add('active');
      }

      aktuelleFrageIndex = frageIndex; // Aktualisiere den globalen Index 
    }

    // Bewertungslogik 
    function evaluateAnswer(frageId, sectionElement, frageData) {
        const userAnswer = sectionElement.querySelector(`#user-answer-${frageId}`).value; [cite: 2]
        const feedbackSection = sectionElement.querySelector(`#feedback-${frageId}`); [cite: 2]
        const criteriaFeedbackDiv = feedbackSection.querySelector('.criteria-feedback'); [cite: 2]
        const scorePercentageSpan = feedbackSection.querySelector('.score-percentage'); [cite: 2]
        criteriaFeedbackDiv.innerHTML = ''; // Alten Feedback löschen 
        feedbackSection.style.display = 'block'; [cite: 2]

        let totalPossibleScore = 0; [cite: 2]
        let userAchievedScore = 0; [cite: 2]

        const userWords = cleanAndStemText(userAnswer, stemWordFunc); [cite: 2]

        frageData.bewertungskriterien.forEach(criterion => { [cite: 2]
            const feedbackItem = document.createElement('div'); [cite: 2]
            feedbackItem.classList.add('feedback-item'); [cite: 2]
            let criterionScore = 0; [cite: 2]
            let keywordFound = false; // Add a flag to track if any keyword for the criterion is found 

            totalPossibleScore += 2; // Each criterion is worth 2 points if fully recognized and described 

            // Check for keywords 
            for (const keyword of criterion.keywords) { [cite: 2]
                const stemmedKeyword = stemWordFunc(keyword.toLowerCase()); [cite: 2]
                if (userWords.includes(stemmedKeyword)) {
                    keywordFound = true; [cite: 2]
                    break; // Found a keyword, no need to check further for this criterion 
                }
            }

            if (keywordFound) {
                // Check word count for sufficient description 
                const cleanUserAnswer = userAnswer.toLowerCase().replace(/[.,!?;:()"]/g, '');
                const sentences = cleanUserAnswer.split(/[.!?\n]/).filter(s => s.trim().length > 0);
                let sufficientlyDescribed = false;

                for (const sentence of sentences) {
                    const stemmedSentenceWords = cleanAndStemText(sentence, stemWordFunc);
                    const sentenceWordCount = sentence.split(/\s+/).filter(word => word.length > 0).length;

                    // Check if any of the criterion's keywords are in the sentence
                    const criterionKeywordsStemmed = criterion.keywords.map(kw => stemWordFunc(kw.toLowerCase()));
                    const hasCriterionKeywordInSentence = criterionKeywordsStemmed.some(skw => stemmedSentenceWords.includes(skw));

                    if (hasCriterionKeywordInSentence && sentenceWordCount >= criterion.minWoerterFuerBeschreibung) {
                        sufficientlyDescribed = true;
                        break;
                    }
                }

                if (sufficientlyDescribed) {
                    criterionScore = 2; // Full points 
                    feedbackItem.classList.add('positive'); [cite: 2]
                    feedbackItem.innerHTML = `<strong>${criterion.name}:</strong> Sehr gut! Der Punkt wurde genannt und ausreichend beschrieben.`; [cite: 2]
                } else {
                    criterionScore = 1; // Partial points 
                    feedbackItem.classList.add('neutral'); [cite: 2]
                    feedbackItem.innerHTML = `<strong>${criterion.name}:</strong> ${criterion.feedback_kurz || 'Der Punkt wurde genannt, aber die Beschreibung ist noch nicht ausreichend.'}`; [cite: 2]
                }
            } else {
                criterionScore = 0; // No points 
                feedbackItem.classList.add('negative'); [cite: 2]
                feedbackItem.innerHTML = `<strong>${criterion.name}:</strong> Nicht gefunden. Ihre Antwort sollte diesen Punkt behandeln.`; [cite: 2]
            }
            userAchievedScore += criterionScore; [cite: 2]
            criteriaFeedbackDiv.appendChild(feedbackItem); [cite: 2]
        });

        const overallPercentage = totalPossibleScore > 0 ? ((userAchievedScore / totalPossibleScore) * 100).toFixed(0) : 0; [cite: 2]
        scorePercentageSpan.textContent = overallPercentage; [cite: 2]
    }

    // Hilfsfunktion zum Bereinigen und Stemmen des Textes 
    function cleanAndStemText(text, stemmer) {
        const cleanedText = text.toLowerCase().replace(/[.,!?;:()"]/g, ''); [cite: 2]
        return cleanedText.split(/\s+/).filter(word => word.length > 0).map(word => stemmer(word)); [cite: 2]
    }

    // Initialisierung beim Laden der Seite 
    async function initialisiereApp() {
      const hash = window.location.hash.substring(1);
      const startThemaID = hash || 'pe-prozess'; // Standardthema 'pe-prozess' oder aus URL-Hash
      zeigeThema(startThemaID); // Zeige das Startthema 
    }
  </script>

</body>
</html>
