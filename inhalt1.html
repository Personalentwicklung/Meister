<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalentwicklungsprozess Bewertung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; line-height: 1.6; color: #333; margin: 20px; background-color: #f4f4f4; }
        .container { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0056b3; }
        .question-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        .form-label { font-weight: bold; }
        .feedback-section { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .feedback-item { margin-bottom: 10px; padding: 10px; border-left: 5px solid; border-radius: 3px; }
        .feedback-item.positive { border-color: #28a745; background-color: #e6ffe6; }
        .feedback-item.neutral { border-color: #ffc107; background-color: #fff8e6; }
        .feedback-item.negative { border-color: #dc3545; background-color: #ffe6e6; }
        .score-display { font-size: 1.2em; font-weight: bold; margin-top: 20px; }
        .correct-answer-toggle { margin-top: 20px; }
        .correct-answer-content { background-color: #e9ecef; padding: 15px; border-radius: 5px; border: 1px dashed #ccc; margin-top: 10px; white-space: pre-wrap; word-wrap: break-word; }
        .btn-check-answer { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .btn-check-answer:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Bewertung der Personalentwicklungsprozess-Fragen</h1>
        
        <div id="questionsContainer">
            </div>

        <template id="questionTemplate">
            <div class="question-section" data-question-id="">
                <h3 class="question-title"></h3>
                <p class="question-text"></p>
                <div class="mb-3">
                    <label for="answerText" class="form-label">Ihre Antwort:</label>
                    <textarea class="form-control user-answer" rows="8"></textarea>
                </div>
                <button class="btn btn-primary mt-2 btn-check-answer">Antwort überprüfen</button>
                
                <div class="feedback-section" style="display:none;">
                    <h4>Bewertung:</h4>
                    <div class="criteria-feedback"></div>
                    <div class="score-display">Gesamterreichung: <span class="score-percentage"></span>%</div>
                </div>

                <div class="correct-answer-toggle">
                    <button class="btn btn-info btn-toggle-musterloesung">Musterlösung anzeigen</button>
                    <div class="correct-answer-content" style="display:none;"></div>
                </div>
            </div>
        </template>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./index.js"></script> <script>
        let questionsData = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadQuestions();
        });

        async function loadQuestions() {
            try {
                const response = await fetch('./fragen_pe-prozess.json');
                questionsData = await response.json();
                displayQuestions(questionsData);
            } catch (error) {
                console.error('Fehler beim Laden der Fragen:', error);
                document.getElementById('questionsContainer').innerHTML = '<p class="text-danger">Fragen konnten nicht geladen werden.</p>';
            }
        }

        function displayQuestions(questions) {
            const container = document.getElementById('questionsContainer');
            const template = document.getElementById('questionTemplate');

            questions.forEach(question => {
                const clone = document.importNode(template.content, true);
                const section = clone.querySelector('.question-section');
                section.dataset.questionId = question.id;
                clone.querySelector('.question-title').textContent = question.titel;
                clone.querySelector('.question-text').textContent = question.frageText;
                clone.querySelector('.correct-answer-content').textContent = question.musterloesung;

                const checkButton = clone.querySelector('.btn-check-answer');
                checkButton.addEventListener('click', () => evaluateAnswer(question.id, section));

                const toggleMusterloesungButton = clone.querySelector('.btn-toggle-musterloesung');
                toggleMusterloesungButton.addEventListener('click', () => {
                    const content = section.querySelector('.correct-answer-content');
                    content.style.display = content.style.display === 'none' ? 'block' : 'none';
                    toggleMusterloesungButton.textContent = content.style.display === 'none' ? 'Musterlösung anzeigen' : 'Musterlösung ausblenden';
                });

                container.appendChild(clone);
            });
        }

        function evaluateAnswer(questionId, sectionElement) {
            const question = questionsData.find(q => q.id === questionId);
            const userAnswer = sectionElement.querySelector('.user-answer').value;
            const feedbackSection = sectionElement.querySelector('.feedback-section');
            const criteriaFeedbackDiv = sectionElement.querySelector('.criteria-feedback');
            const scorePercentageSpan = sectionElement.querySelector('.score-percentage');

            criteriaFeedbackDiv.innerHTML = ''; // Alten Feedback löschen
            feedbackSection.style.display = 'block';

            let totalCriteria = question.bewertungskriterien.length;
            let achievedCriteria = 0;
            let totalPossibleScore = 0; // Each criterion gives 1 point for presence and 1 for good description
            let userAchievedScore = 0;

            const userWords = cleanAndStemText(userAnswer);

            question.bewertungskriterien.forEach(criterion => {
                const feedbackItem = document.createElement('div');
                feedbackItem.classList.add('feedback-item');
                let criterionScore = 0;
                let keywordFound = false;
                let descriptionAdequate = false;

                // Check for keywords
                for (const keyword of criterion.keywords) {
                    const stemmedKeyword = stemWord(keyword.toLowerCase());
                    if (userWords.includes(stemmedKeyword)) {
                        keywordFound = true;
                        break;
                    }
                }

                if (keywordFound) {
                    criterionScore += 1; // 1 point for mentioning the criterion
                    totalPossibleScore += 1;

                    // Check word count for description adequacy (a very basic proxy)
                    // This is a simplified check. A more robust solution would involve NLP.
                    const wordsInUserAnswer = userAnswer.split(/\s+/).filter(word => word.length > 0);
                    if (wordsInUserAnswer.length >= criterion.minWoerterFuerBeschreibung) {
                        descriptionAdequate = true;
                        criterionScore += 1; // 1 point for adequate description
                        totalPossibleScore += 1;
                    }
                } else {
                     // Even if keyword not found, still contribute to totalPossibleScore for criteria not met
                    totalPossibleScore += 2; // Each criterion has potential for 2 points (mention + description)
                }

                userAchievedScore += criterionScore;

                if (criterionScore === 2) {
                    feedbackItem.classList.add('positive');
                    feedbackItem.innerHTML = `<strong>${criterion.name}:</strong> Sehr gut! Der Punkt wurde genannt und ausreichend beschrieben.`;
                    achievedCriteria++;
                } else if (criterionScore === 1) {
                    feedbackItem.classList.add('neutral');
                    feedbackItem.innerHTML = `<strong>${criterion.name}:</strong> ${criterion.feedback_kurz || 'Der Punkt wurde genannt, aber die Beschreibung ist noch nicht ausreichend.'}`;
                } else {
                    feedbackItem.classList.add('negative');
                    feedbackItem.innerHTML = `<strong>${criterion.name}:</strong> Nicht gefunden. Ihre Antwort sollte diesen Punkt behandeln.`;
                }
                criteriaFeedbackDiv.appendChild(feedbackItem);
            });

            const overallPercentage = totalPossibleScore > 0 ? ((userAchievedScore / totalPossibleScore) * 100).toFixed(0) : 0;
            scorePercentageSpan.textContent = overallPercentage;
        }

        // Hilfsfunktion zum Bereinigen und Stemmen des Textes
        function cleanAndStemText(text) {
            // Text in Kleinbuchstaben umwandeln und Satzzeichen entfernen
            const cleanedText = text.toLowerCase().replace(/[.,!?;:()"]/g, '');
            // Wörter aufsplitten und jedes Wort stemmen
            return cleanedText.split(/\s+/).map(word => stemWord(word));
        }

        // Die stemWord Funktion wird von der inkludierten index.js bereitgestellt
        // Stellen Sie sicher, dass index.js die Funktion snowballFactory() und den deutschen Stemmer enthält.
        // Die Funktion muss global verfügbar sein oder entsprechend importiert werden.
        // Da die SnowballFactory in index.js ein Objekt zurückgibt, muss die stemWord Funktion daraus extrahiert werden.
        let stemWord;
        if (typeof snowballFactory !== 'undefined') {
            const germanStemmer = snowballFactory.newStemmer('German');
            stemWord = (word) => germanStemmer.stem(word);
        } else {
            console.error('Snowball Stemmer (index.js) wurde nicht korrekt geladen oder snowballFactory ist nicht verfügbar.');
            // Fallback: Wenn der Stemmer nicht geladen wird, geben wir das Wort unverändert zurück.
            // Dies beeinflusst die Qualität der Bewertung, verhindert aber einen Absturz.
            stemWord = (word) => word;
        }

    </script>
</body>
</html>
