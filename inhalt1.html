<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIKP - Themen</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 800px; margin: auto; background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); display: none; }
        h1, h2 { color: #1a4e8a; text-align: center; }
        .thema { margin-bottom: 30px; border-bottom: 2px solid #cddff5; padding-bottom: 20px; }
        .frage { background-color: #e6eff9; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        textarea { width: 100%; height: 100px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; margin-top: 10px; }
        button { background-color: #1a4e8a; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #1a3e7a; }
    </style>
</head>
<body>

<div class="container">
    <h1>MIKP - Themen</h1>

    <p style="text-align:center;">
        <a href="#pe-prozess">PE-Prozess</a> | 
        <a href="#potenzial-kompetenz">Potenzial und Kompetenz</a>
    </p>

    <div id="pe-prozess" class="thema">
        <h2>Thema 1: Der PE-Prozess</h2>
        <div class="frage" data-thema="pe-prozess" data-frage="1">
            <p>1. Beschreibe die Phasen des PE-Prozesses in eigenen Worten.</p>
            <textarea placeholder="Deine Antwort hier..."></textarea>
            <button onclick="auswerten(this)">Speichern</button>
        </div>
        <div class="frage" data-thema="pe-prozess" data-frage="2">
            <p>2. Warum ist die Bedarfsanalyse im PE-Prozess so wichtig?</p>
            <textarea placeholder="Deine Antwort hier..."></textarea>
            <button onclick="auswerten(this)">Speichern</button>
        </div>
        <div class="frage" data-thema="pe-prozess" data-frage="3">
            <p>3. Was versteht man unter dem Begriff "Transfer" im PE-Prozess?</p>
            <textarea placeholder="Deine Antwort hier..."></textarea>
            <button onclick="auswerten(this)">Speichern</button>
        </div>
    </div>

    <div id="potenzial-kompetenz" class="thema">
        <h2>Thema 2: Potenzial und Kompetenz</h2>
        <div class="frage" data-thema="potenzial-kompetenz" data-frage="1">
            <p>1. Erkläre den Unterschied zwischen Potenzial und Kompetenz.</p>
            <textarea placeholder="Deine Antwort hier..."></textarea>
            <button onclick="auswerten(this)">Speichern</button>
        </div>
        <div class="frage" data-thema="potenzial-kompetenz" data-frage="2">
            <p>2. Wie können Potenziale im Unternehmen identifiziert werden?</p>
            <textarea placeholder="Deine Antwort hier..."></textarea>
            <button onclick="auswerten(this)">Speichern</button>
        </div>
        <div class="frage" data-thema="potenzial-kompetenz" data-frage="3">
            <p>3. Nenne die drei Kompetenzbereiche nach Weinert.</p>
            <textarea placeholder="Deine Antwort hier..."></textarea>
            <button onclick="auswerten(this)">Speichern</button>
        </div>
    </div>

</div>

<script type="module" src="firebase-logic.js"></script>

<script type="module">
    // Wichtige Änderung: Wir importieren nur noch die 'auth'- und 'db'-Objekte
    import { auth, db } from './firebase-logic.js';

    // Sicherstellen, dass der Benutzer angemeldet ist
    // Wichtige Änderung: auth.onAuthStateChanged wird direkt aufgerufen
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "index.html"; // Weiterleitung, wenn nicht angemeldet
      } else {
        document.querySelector('.container').style.display = 'block';
      }
    });

    async function auswerten(buttonElement) {
        // Wichtige Änderung: auth.currentUser ist direkt verfügbar
        const userId = auth.currentUser.uid; 
        const frageDiv = buttonElement.closest('.frage');
        const themaId = frageDiv.dataset.thema;
        const frageId = frageDiv.dataset.frage;
        const antwort = frageDiv.querySelector('textarea').value;

        if (antwort.trim() === '') {
            alert('Bitte gib eine Antwort ein, bevor du speicherst.');
            return;
        }

        // Wichtige Änderung: db.doc und db.getDoc werden direkt aufgerufen
        const userDocRef = db.doc(db, "users", userId);
        const userDocSnap = await db.getDoc(userDocRef);

        let dataToUpdate = {};
        if (userDocSnap.exists()) {
            dataToUpdate = userDocSnap.data();
        }

        // Stelle sicher, dass das Thema-Objekt existiert
        if (!dataToUpdate[themaId]) {
            dataToUpdate[themaId] = {};
        }

        // Speichere die Antwort
        dataToUpdate[themaId][frageId] = antwort;

        try {
            // Wichtige Änderung: db.setDoc wird direkt aufgerufen
            await db.setDoc(userDocRef, dataToUpdate, { merge: true });
            buttonElement.textContent = "Gespeichert!";
            buttonElement.disabled = true;
            alert('Deine Antwort wurde erfolgreich gespeichert!');
        } catch (e) {
            console.error("Fehler beim Speichern der Antwort: ", e);
            alert('Es gab einen Fehler beim Speichern deiner Antwort.');
        }
    }
</script>

</body>
</html>
